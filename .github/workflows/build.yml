name: Build and test
on: push
jobs:
    cypress-run:
        runs-on: ubuntu-22.04
        steps:
        - name: Checkout sources
          uses: actions/checkout@v4
          
        - name: Setup Java
          uses: actions/setup-java@v4
          with:
            distribution: 'corretto'
            java-version: 17

        - name: Setup Gradle
          uses: gradle/actions/setup-gradle@v3

        - name: Checkout
          run: |
            git clone https://bitbucket.org/thiagohcn/customer-data-api-java.git 
            cd customer-data-api-java

        - name: Build docker
          run:  docker build -t customer-api-server .
          
        - name: Run container in background
          run:  |
            docker run -d -p 8080:8080 --name customer-api-server -t customer-api-server 
            cd ..

        - name: Cypress run
          uses: cypress-io/github-action@v6
          with:
            command: npm run test
            wait-on: 'http://localhost:8080'